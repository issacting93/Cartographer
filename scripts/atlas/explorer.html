<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Cartography Explorer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="file_list.js"></script>
    <link href="css/bloom.css" rel="stylesheet">
    <link href="css/explorer.css" rel="stylesheet">
</head>

<body>

    <div id="left-panel" class="panel">
        <div class="guide-header"
            style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--gray);">
            <h1>BLOOM Explorer</h1>
            <p style="font-size: 12px; color: var(--text-dim);">Interactional Cartography v3.0</p>
        </div>

        <div class="panel-section">
            <div class="panel-title">Data Source</div>
            <div id="drop-zone">
                Drop Atlas JSON here<br>
                <span class="hint">or click to upload</span>
                <input type="file" id="file-input" style="display: none" accept=".json">
            </div>


            <div id="file-selector-container">
                <input type="text" id="file-search" list="file-list" placeholder="Search conversations...">
                <datalist id="file-list"></datalist>
                <div style="margin-top: 10px; display: flex; justify-content: flex-end;">
                    <button id="load-btn" class="btn btn-primary">
                        <span class="material-symbols-rounded">play_arrow</span> Load
                    </button>
                </div>
            </div>

            <div id="controls">
                <div class="panel-title" style="margin-top: 20px;">Layout Mode</div>
                <select id="layout-select">
                    <option value="radial">Radial Layout</option>
                    <option value="timeline">Timeline Layout</option>
                    <option value="hierarchical">Hierarchical Layout</option>
                    <option value="force">Force Layout</option>
                </select>
            </div>
        </div>

        <div class="legend panel-section">
            <div class="panel-title">Filters</div>
            <div id="filter-legend" class="legend" style="display: flex; flex-wrap: wrap; gap: 6px;">
                <label class="pill active" data-type="Conversation">
                    <input type="checkbox" checked class="filter-cb" data-type="Conversation" style="display:none">
                    <span class="swatch" style="background: var(--black)"></span> Conversation
                </label>
                <label class="pill active" data-type="Turn">
                    <input type="checkbox" checked class="filter-cb" data-type="Turn" style="display:none">
                    <span class="swatch" style="background: var(--yellow)"></span> Turn
                </label>
                <div class="pill static" style="cursor: default;">
                    <span class="swatch" style="background: #000000"></span> Start
                </div>
                <div class="pill static" style="cursor: default; border: 1px solid #e2e8f0;">
                    <span class="swatch" style="background: #ffffff; border: 1px solid #1a1a1a;"></span> End
                </div>
                <label class="pill active" data-type="Constraint">
                    <input type="checkbox" checked class="filter-cb" data-type="Constraint" style="display:none">
                    <span class="swatch" style="background: var(--orange)"></span> Constraint
                </label>
                <label class="pill active" data-type="Move">
                    <input type="checkbox" checked class="filter-cb" data-type="Move" style="display:none">
                    <span class="swatch" style="background: #60a5fa"></span> Move
                </label>
                <div class="pill static" style="cursor: default;">
                    <span class="swatch" style="background: #22c55e"></span> Repair
                </div>
                <div class="pill static" style="cursor: default;">
                    <span class="swatch" style="background: #ef4444"></span> Violation
                </div>
            </div>
            <div class="panel-title" style="margin-top: 10px;">Edge Key</div>
            <div class="edge-legend">
                <div class="edge-legend-item">
                    <div class="edge-swatch" style="background:#64748b"></div>NEXT
                </div>
                <div class="edge-legend-item">
                    <div class="edge-swatch" style="background:#60a5fa"></div>CONTAINS
                </div>
                <div class="edge-legend-item">
                    <div class="edge-swatch" style="background:#f87171"></div>VIOLATES
                </div>
                <div class="edge-legend-item">
                    <div class="edge-swatch" style="background:#4ade80"></div>REPAIR
                </div>
                <div class="edge-legend-item">
                    <div class="edge-swatch" style="background:#c084fc"></div>RATIFIES
                </div>
                <div class="edge-legend-item">
                    <div class="edge-swatch" style="background:#fbbf24"></div>TRIGGERS
                </div>
            </div>
        </div>
    </div>

    <div id="center-panel">
        <div class="tooltip" id="tooltip"></div>
        <svg id="viz"></svg>
    </div>

    <div id="right-panel" class="panel">
        <!-- Summary Stats Bar (shown after graph load) -->
        <div id="summary-stats" class="panel-section">
            <div class="panel-title">Conversation Summary</div>
            <div class="stat-row"><span class="stat-label">ID</span><span class="stat-value" id="stat-conv-id">—</span>
            </div>
            <div class="stat-row"><span class="stat-label">Turns</span><span class="stat-value" id="stat-turns">—</span>
            </div>
            <div class="stat-row"><span class="stat-label">Constraints</span><span class="stat-value"
                    id="stat-constraints">—</span></div>
            <div class="stat-row"><span class="stat-label">Violations</span><span class="stat-value"
                    id="stat-violations">—</span></div>
            <div class="stat-row"><span class="stat-label">Repairs</span><span class="stat-value"
                    id="stat-repairs">—</span></div>
            <div class="stat-row"><span class="stat-label">Drift Velocity</span><span class="stat-value"
                    id="stat-drift">—</span></div>
            <div class="stat-row"><span class="stat-label">Survival</span><span class="stat-value"
                    id="stat-survival">—</span></div>
            <div class="stat-row"><span class="stat-label">Mode Violations</span><span class="stat-value"
                    id="stat-mode-viols">—</span></div>
            <div class="stat-row"><span class="stat-label">Stability</span><span class="stat-value"
                    id="stat-stability">—</span></div>
        </div>

        <!-- Constraint State Timeline -->
        <div id="constraint-timeline" class="panel-section">
            <div class="panel-title">Constraint Lifecycles</div>
            <div id="timeline-content"></div>
        </div>

        <div id="metadata-panel" class="node-info" style="display: none;">
            <div class="panel-title">Node Inspector</div>
            <pre id="metadata-content"></pre>
        </div>

        <div id="empty-details" style="text-align: center; color: #64748b; margin-top: 50px;">
            <svg viewBox="0 0 24 24" width="48" height="48" style="fill: #334155; margin-bottom: 10px;">
                <path
                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
            </svg>
            <p>Select a node in the graph to view properties</p>
        </div>
    </div>

    <!-- Application Assets -->
    <script src="js/file_list.js"></script>
    <script src="js/config.js"></script>
    <script src="js/explorer.js"></script>